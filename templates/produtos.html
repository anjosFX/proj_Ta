<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Loja de Camisas</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.jpg') }}">
  <style>
    
  </style>
</head>
<body>
  <!-- navbar -->
  <nav class="navbar">
    <div class="logo">
      <img src="{{ url_for('static', filename='images/logo.png') }}" alt="logo" width="100" height="50">
    </div>
    <div class="menu">
      <a href="/">In√≠cio</a>
      {% if session.usuario %}
        <a href="/carrinho">Carrinho</a>
        <a href="/perfil">Perfil</a>
        <a href="/logout">Sair</a>
        <a href="/chat">chat</a>
        <a href="/faq">FAQ</a>
      {% else %}
        <a href="/login">Login</a>
        <a href="/cadastro">Cadastro</a>
      {% endif %}
    </div>
  </nav>

  <!-- conte√∫do -->
  <main class="content">
    <h1>Produtos Dispon√≠veis</h1>
    <ul class="products">
      {% for produto in produtos %}
      <li class="product-card">
        <img src="{{ produto.imagem or url_for('static', filename='placeholder.png') }}" alt="{{ produto.nome }}">
        <strong>{{ produto.nome }}</strong>
        <p>{{ produto.descricao }}</p>
        <p class="price">R$ {{ produto.preco }}</p>

        {% if session.usuario %}
        <form action="/adicionar_carrinho" method="POST" class="buy-form">
          <input type="hidden" name="produto_id" value="{{ produto.id }}">
          <input type="number" name="quantidade" value="1" min="1" hidden>
          <button type="submit">Adicionar</button>
        </form>
        {% else %}
        <p><em>Fa√ßa login para comprar</em></p>
        {% endif %}
      </li>
      {% endfor %}
    </ul>


      <!-- Se√ß√£o de Produtos Recomendados -->
<!-- Se√ß√£o de Recomenda√ß√µes com IA -->
<section class="recommended-section" id="secaoRecomendados">
    <h2 class="section-title">
         Recomenda√ß√µes inteligentes
        <span class="recommended-badge">PARA VOC√ä</span>
    </h2>
    
    <div style="text-align: center; margin-bottom: 20px;">
        <small style="color: var(--accent);">
            Sistema de recomenda√ß√£o baseado em similaridade de produtos
        </small>
    </div>
    
    <div class="recommended-products" id="produtosRecomendados">
        <div style="text-align: center; padding: 40px;">
            <p>üéØ Carregando recomenda√ß√µes inteligentes...</p>
            <small>Analisando padr√µes de compra para sugest√µes personalizadas</small>
        </div>
    </div>
</section>


<script>
// Carrega recomenda√ß√µes quando a p√°gina carrega
document.addEventListener('DOMContentLoaded', function() {
    carregarRecomendacoes();
});

async function carregarRecomendacoes() {
    try {
        const response = await fetch('/recomendacoes_personalizadas');
        const produtos = await response.json();
        
        const container = document.getElementById('produtosRecomendados');
        container.innerHTML = '';
        
        if (produtos.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <p> Sistema de IA em treinamento...</p>
                    <small>Realize compras para melhorar as recomenda√ß√µes</small>
                </div>
            `;
            return;
        }
        
        produtos.forEach(produto => {
            const card = document.createElement('div');
            card.className = 'recommended-card';
            card.innerHTML = `
                <img src="${produto.imagem || '{{ url_for("static", filename="placeholder.png") }}'}" 
                     alt="${produto.nome}" 
                     onerror="this.src='{{ url_for("static", filename="placeholder.png") }}'">
                <strong>${produto.nome}</strong>
                <p>${produto.descricao}</p>
                <p class="price">R$ ${produto.preco.toFixed(2)}</p>
                ${'{{ session.usuario }}' ? `
                <form action="/adicionar_carrinho" method="POST" class="buy-form">
                    <input type="hidden" name="produto_id" value="${produto.id}">
                    <input type="number" name="quantidade" value="1" min="1" hidden>
                    <button type="submit">Adicionar</button>
                </form>
                ` : `
                <p><em>Fa√ßa login para comprar</em></p>
                `}
            `;
            container.appendChild(card);
        });
        
    } catch (error) {
        console.error('Erro ao carregar recomenda√ß√µes:', error);
        document.getElementById('produtosRecomendados').innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <p>‚ö†Ô∏è Erro ao carregar recomenda√ß√µes</p>
                <small>Tente recarregar a p√°gina</small>
            </div>
        `;
    }
}
</script>
  </main>

  <!-- footer -->
  <footer class="footer">
    <p>¬© 2025 FeKnight Store Todos os direitos reservados</p>
  </footer>

  <!-- Chat Container -->
<div class="chat-container">
    <button class="chat-button" id="chatToggle">üí¨</button>
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <h3>Atendente Virtual - FeKnight</h3>
            <button class="close-chat" id="closeChat">√ó</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message bot-message">
                Ol√°! Sou o assistente virtual da FeKnight Store. Como posso ajudar?
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="Digite sua mensagem...">
            <button id="sendMessage">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>
</div>


<script>
    // Elementos do chat
    const chatToggle = document.getElementById('chatToggle');
    const chatWindow = document.getElementById('chatWindow');
    const closeChat = document.getElementById('closeChat');
    const messageInput = document.getElementById('messageInput');
    const sendMessage = document.getElementById('sendMessage');
    const chatMessages = document.getElementById('chatMessages');

    // Alternar visibilidade do chat
    chatToggle.addEventListener('click', () => {
        chatWindow.style.display = chatWindow.style.display === 'flex' ? 'none' : 'flex';
        if (chatWindow.style.display === 'flex') {
            messageInput.focus();
        }
    });

    // Fechar chat
    closeChat.addEventListener('click', () => {
        chatWindow.style.display = 'none';
    });

    // Enviar mensagem para o ChatterBot
    async function sendUserMessage() {
        const message = messageInput.value.trim();
        if (message) {
            // Adicionar mensagem do usu√°rio
            const userMessage = document.createElement('div');
            userMessage.classList.add('message', 'user-message');
            userMessage.textContent = message;
            chatMessages.appendChild(userMessage);
            
            // Limpar campo de entrada
            messageInput.value = '';
            
            // Mostrar indicador de digita√ß√£o
            const typingIndicator = document.createElement('div');
            typingIndicator.classList.add('message', 'bot-message');
            typingIndicator.id = 'typing';
            typingIndicator.textContent = 'Digitando...';
            chatMessages.appendChild(typingIndicator);
            
            // Rolar para baixo
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                // Enviar mensagem para o backend Flask
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mensagem: message
                    })
                });
                
                const data = await response.json();
                
                // Remover indicador de digita√ß√£o
                document.getElementById('typing').remove();
                
                // Adicionar resposta do bot
                const botMessage = document.createElement('div');
                botMessage.classList.add('message', 'bot-message');
                botMessage.textContent = data.resposta;
                chatMessages.appendChild(botMessage);
                
            } catch (error) {
                console.error('Erro:', error);
                // Remover indicador de digita√ß√£o
                document.getElementById('typing').remove();
                
                // Mensagem de erro
                const errorMessage = document.createElement('div');
                errorMessage.classList.add('message', 'bot-message');
                errorMessage.textContent = 'Desculpe, estou com problemas t√©cnicos. Tente novamente.';
                chatMessages.appendChild(errorMessage);
            }
            
            // Rolar para baixo novamente
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    // Enviar mensagem ao clicar no bot√£o
    sendMessage.addEventListener('click', sendUserMessage);

    // Enviar mensagem ao pressionar Enter
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendUserMessage();
        }
    });
</script>
</body>
</html>